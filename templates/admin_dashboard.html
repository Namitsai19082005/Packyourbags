{% extends "base.html" %}

{% block title %}Admin Dashboard - Pack Your Bags{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-0">
            <div class="list-group list-group-flush">
                <a href="#dashboard" class="list-group-item list-group-item-action active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </a>
                <a href="#users" class="list-group-item list-group-item-action" onclick="showSection('users')">
                    <i class="fas fa-users me-2"></i>Users
                </a>
                <a href="#packages" class="list-group-item list-group-item-action" onclick="showSection('packages')">
                    <i class="fas fa-box me-2"></i>Packages
                </a>
                <a href="#bookings" class="list-group-item list-group-item-action" onclick="showSection('bookings')">
                    <i class="fas fa-calendar-check me-2"></i>Bookings
                </a>
                <a href="#reviews" class="list-group-item list-group-item-action" onclick="showSection('reviews')">
                    <i class="fas fa-star me-2"></i>Reviews
                </a>
                <a href="#payments" class="list-group-item list-group-item-action" onclick="showSection('payments')">
                    <i class="fas fa-credit-card me-2"></i>Payments
                </a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-10 main-content p-4">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section">
                <h2>Dashboard Overview</h2>
                <div class="row" id="statsContainer">
                    <!-- Stats will be loaded here -->
                </div>
                
                <!-- Recent Activity -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Recent Bookings</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentBookings">
                                    <!-- Recent bookings will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Recent Reviews</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentReviews">
                                    <!-- Recent reviews will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Users Section -->
            <div id="users-section" class="section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>User Management</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="exportUsers()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <button class="btn btn-primary" onclick="showAddUserModal()">
                            <i class="fas fa-plus me-2"></i>Add User
                        </button>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="roleFilter">
                                    <option value="">All Roles</option>
                                    <option value="end_user">End User</option>
                                    <option value="travel_agent">Travel Agent</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" onclick="filterUsers()">Filter</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Packages Section -->
            <div id="packages-section" class="section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Package Management</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="exportPackages()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <button class="btn btn-primary" onclick="showAddPackageModal()">
                            <i class="fas fa-plus me-2"></i>Add Package
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Destination</th>
                                        <th>Price</th>
                                        <th>Duration</th>
                                        <th>Max Travelers</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="packagesTableBody">
                                    <!-- Packages will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bookings Section -->
            <div id="bookings-section" class="section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Booking Management</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="exportBookings()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>User</th>
                                        <th>Package</th>
                                        <th>Date</th>
                                        <th>Travelers</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bookingsTableBody">
                                    <!-- Bookings will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reviews Section -->
            <div id="reviews-section" class="section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Review Management</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="exportReviews()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>User</th>
                                        <th>Package</th>
                                        <th>Rating</th>
                                        <th>Comment</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reviewsTableBody">
                                    <!-- Reviews will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payments Section -->
            <div id="payments-section" class="section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Payment Management</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="exportPayments()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Booking ID</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Payment Method</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTableBody">
                                    <!-- Payments will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardStats();
        loadRecentActivity();
    });
    
    function showSection(sectionName) {
        // Hide all sections
        document.querySelectorAll('.section').forEach(section => {
            section.style.display = 'none';
        });
        
        // Show selected section
        document.getElementById(sectionName + '-section').style.display = 'block';
        
        // Update active nav item
        document.querySelectorAll('.list-group-item').forEach(item => {
            item.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Load section data
        switch(sectionName) {
            case 'dashboard':
                loadDashboardStats();
                loadRecentActivity();
                break;
            case 'users':
                loadUsers();
                break;
            case 'packages':
                loadPackages();
                break;
            case 'bookings':
                loadBookings();
                break;
            case 'reviews':
                loadReviews();
                break;
            case 'payments':
                loadPayments();
                break;
        }
    }
    
    async function loadDashboardStats() {
        try {
            const response = await fetch('/api/admin/stats', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            const data = await response.json();
            
            const container = document.getElementById('statsContainer');
            container.innerHTML = `
                <div class="col-md-3 mb-4">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-users fa-3x mb-3"></i>
                            <h3>${data.users.total}</h3>
                            <p class="mb-0">Total Users</p>
                            <small>${data.users.active} Active</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-box fa-3x mb-3"></i>
                            <h3>${data.packages.total}</h3>
                            <p class="mb-0">Total Packages</p>
                            <small>${data.packages.active} Active</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-calendar-check fa-3x mb-3"></i>
                            <h3>${data.bookings.total}</h3>
                            <p class="mb-0">Total Bookings</p>
                            <small>${data.bookings.pending} Pending</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-rupee-sign fa-3x mb-3"></i>
                            <h3>₹${data.revenue.total}</h3>
                            <p class="mb-0">Total Revenue</p>
                            <small>From ${data.bookings.completed} Completed</small>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    async function loadRecentActivity() {
        // Load recent bookings and reviews
        try {
            const [bookingsResponse, reviewsResponse] = await Promise.all([
                fetch('/api/admin/bookings?per_page=5', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                }),
                fetch('/api/admin/reviews?per_page=5', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                })
            ]);
            
            const bookingsData = await bookingsResponse.json();
            const reviewsData = await reviewsResponse.json();
            
            // Display recent bookings
            const recentBookings = document.getElementById('recentBookings');
            if (bookingsData.bookings && bookingsData.bookings.length > 0) {
                recentBookings.innerHTML = bookingsData.bookings.map(booking => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${booking.user.username}</strong>
                            <br><small class="text-muted">${booking.package.title}</small>
                        </div>
                        <span class="badge bg-${getStatusColor(booking.status)}">${booking.status}</span>
                    </div>
                `).join('');
            } else {
                recentBookings.innerHTML = '<p class="text-muted">No recent bookings</p>';
            }
            
            // Display recent reviews
            const recentReviews = document.getElementById('recentReviews');
            if (reviewsData.reviews && reviewsData.reviews.length > 0) {
                recentReviews.innerHTML = reviewsData.reviews.map(review => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${review.user.username}</strong>
                            <br><small class="text-muted">${review.package.title}</small>
                            <br><div class="rating">${generateStars(review.rating)}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                recentReviews.innerHTML = '<p class="text-muted">No recent reviews</p>';
            }
        } catch (error) {
            console.error('Error loading recent activity:', error);
        }
    }
    
    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            const data = await response.json();
            
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = data.users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.phone_number || 'N/A'}</td>
                    <td><span class="badge bg-${user.role === 'admin' ? 'danger' : user.role === 'travel_agent' ? 'warning' : 'primary'}">${user.role}</span></td>
                    <td><span class="badge bg-${user.is_active ? 'success' : 'secondary'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">Edit</button>
                        <button class="btn btn-sm btn-${user.is_active ? 'outline-warning' : 'outline-success'}" onclick="toggleUserStatus(${user.id}, ${user.is_active})">
                            ${user.is_active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    async function loadPackages() {
        try {
            const response = await fetch('/api/admin/packages', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            const data = await response.json();
            
            const tbody = document.getElementById('packagesTableBody');
            tbody.innerHTML = data.packages.map(package => `
                <tr>
                    <td>${package.id}</td>
                    <td>${package.title}</td>
                    <td>${package.destination}</td>
                    <td>₹${package.price}</td>
                    <td>${package.duration_days} days</td>
                    <td>${package.max_travelers}</td>
                    <td><span class="badge bg-${package.is_active ? 'success' : 'secondary'}">${package.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editPackage(${package.id})">Edit</button>
                        <button class="btn btn-sm btn-${package.is_active ? 'outline-warning' : 'outline-success'}" onclick="togglePackageStatus(${package.id}, ${package.is_active})">
                            ${package.is_active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePackage(${package.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading packages:', error);
        }
    }
    
    async function loadBookings() {
        try {
            const response = await fetch('/api/admin/bookings', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            const data = await response.json();
            
            const tbody = document.getElementById('bookingsTableBody');
            tbody.innerHTML = data.bookings.map(booking => `
                <tr>
                    <td>${booking.id}</td>
                    <td>${booking.user.username}</td>
                    <td>${booking.package.title}</td>
                    <td>${new Date(booking.booking_date).toLocaleDateString()}</td>
                    <td>${booking.number_of_travelers}</td>
                    <td>₹${booking.total_amount}</td>
                    <td><span class="badge bg-${getStatusColor(booking.status)}">${booking.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewBooking(${booking.id})">View</button>
                        <button class="btn btn-sm btn-outline-warning" onclick="updateBookingStatus(${booking.id})">Update Status</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading bookings:', error);
        }
    }
    
    async function loadReviews() {
        try {
            const response = await fetch('/api/admin/reviews', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            const data = await response.json();
            
            const tbody = document.getElementById('reviewsTableBody');
            tbody.innerHTML = data.reviews.map(review => `
                <tr>
                    <td>${review.id}</td>
                    <td>${review.user.username}</td>
                    <td>${review.package.title}</td>
                    <td>${generateStars(review.rating)}</td>
                    <td>${review.comment ? review.comment.substring(0, 50) + '...' : 'No comment'}</td>
                    <td>${new Date(review.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteReview(${review.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading reviews:', error);
        }
    }
    
    async function loadPayments() {
        try {
            const response = await fetch('/api/payments/all', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            const data = await response.json();
            
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = data.payments.map(payment => `
                <tr>
                    <td>${payment.id}</td>
                    <td>${payment.booking_id}</td>
                    <td>₹${payment.amount}</td>
                    <td><span class="badge bg-${getPaymentStatusColor(payment.status)}">${payment.status}</span></td>
                    <td>${payment.payment_method || 'N/A'}</td>
                    <td>${new Date(payment.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewPayment(${payment.id})">View</button>
                        ${payment.status === 'completed' ? `<button class="btn btn-sm btn-outline-warning" onclick="refundPayment(${payment.id})">Refund</button>` : ''}
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading payments:', error);
        }
    }
    
    function getStatusColor(status) {
        switch(status) {
            case 'pending': return 'warning';
            case 'confirmed': return 'success';
            case 'cancelled': return 'danger';
            case 'completed': return 'info';
            default: return 'secondary';
        }
    }
    
    function getPaymentStatusColor(status) {
        switch(status) {
            case 'pending': return 'warning';
            case 'completed': return 'success';
            case 'failed': return 'danger';
            case 'refunded': return 'info';
            default: return 'secondary';
        }
    }
    
    function generateStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                stars += '<i class="fas fa-star text-warning"></i>';
            } else {
                stars += '<i class="far fa-star text-warning"></i>';
            }
        }
        return stars;
    }
    
    // Action functions
    function editUser(id) {
        showAlert('Edit user functionality coming soon', 'info');
    }
    
    function toggleUserStatus(id, isActive) {
        const action = isActive ? 'deactivate' : 'activate';
        const endpoint = isActive ? 'deactivate' : 'activate';
        
        fetch(`/api/admin/users/${id}/${endpoint}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (response.ok) {
                showAlert(`User ${action}d successfully`, 'success');
                loadUsers();
            } else {
                showAlert(data.error || `Failed to ${action} user`, 'danger');
            }
        })
        .catch(error => {
            showAlert(`Failed to ${action} user`, 'danger');
        });
    }
    
    
    function deletePackage(id) {
        if (confirm('Are you sure you want to delete this package?')) {
            fetch(`/api/packages/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (response.ok) {
                    showAlert('Package deleted successfully', 'success');
                    loadPackages();
                } else {
                    showAlert(data.error || 'Failed to delete package', 'danger');
                }
            })
            .catch(error => {
                showAlert('Failed to delete package', 'danger');
            });
        }
    }
    
    function viewBooking(id) {
        showAlert('View booking functionality coming soon', 'info');
    }
    
    function updateBookingStatus(id) {
        showAlert('Update booking status functionality coming soon', 'info');
    }
    
    function deleteReview(id) {
        if (confirm('Are you sure you want to delete this review?')) {
            showAlert('Delete review functionality coming soon', 'info');
        }
    }
    
    function viewPayment(id) {
        showAlert('View payment functionality coming soon', 'info');
    }
    
    function refundPayment(id) {
        if (confirm('Are you sure you want to refund this payment?')) {
            showAlert('Refund payment functionality coming soon', 'info');
        }
    }
    
    function showAddUserModal() {
        // Create modal HTML
        const modalHtml = `
            <div class="modal fade" id="addUserModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addUserForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="newUsername" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="newUsername" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="newEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="newEmail" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="newPhone" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="newPhone">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="newRole" class="form-label">Role</label>
                                        <select class="form-select" id="newRole" required>
                                            <option value="end_user">End User</option>
                                            <option value="travel_agent">Travel Agent</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="newPassword" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="newPassword" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                                        <input type="password" class="form-control" id="confirmPassword" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="newUserActive" checked>
                                        <label class="form-check-label" for="newUserActive">
                                            Active Account
                                        </label>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitAddUser()">Add User</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('addUserModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
        modal.show();
    }
    
    function submitAddUser() {
        const password = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (password !== confirmPassword) {
            showAlert('Passwords do not match', 'danger');
            return;
        }
        
        const formData = {
            username: document.getElementById('newUsername').value,
            email: document.getElementById('newEmail').value,
            phone_number: document.getElementById('newPhone').value,
            role: document.getElementById('newRole').value,
            password: password,
            is_active: document.getElementById('newUserActive').checked
        };
        
        fetch('/api/admin/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('User added successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                loadUsers();
            } else {
                showAlert(data.message || 'Failed to add user', 'danger');
            }
        })
        .catch(error => {
            showAlert('Error adding user', 'danger');
        });
    }
    
    function editUser(userId) {
        // Get user data first
        fetch(`/api/admin/users/${userId}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showEditUserModal(data.user);
            } else {
                showAlert('Failed to load user data', 'danger');
            }
        })
        .catch(error => {
            showAlert('Error loading user data', 'danger');
        });
    }
    
    function showEditUserModal(user) {
        const modalHtml = `
            <div class="modal fade" id="editUserModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editUserForm">
                                <input type="hidden" id="editUserId" value="${user.id}">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editUsername" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="editUsername" value="${user.username}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="editEmail" value="${user.email}" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editPhone" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="editPhone" value="${user.phone_number || ''}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editRole" class="form-label">Role</label>
                                        <select class="form-select" id="editRole" required>
                                            <option value="end_user" ${user.role === 'end_user' ? 'selected' : ''}>End User</option>
                                            <option value="travel_agent" ${user.role === 'travel_agent' ? 'selected' : ''}>Travel Agent</option>
                                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="editUserActive" ${user.is_active ? 'checked' : ''}>
                                        <label class="form-check-label" for="editUserActive">
                                            Active Account
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editPassword" class="form-label">New Password (leave blank to keep current)</label>
                                    <input type="password" class="form-control" id="editPassword">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitEditUser()">Update User</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('editUserModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
        modal.show();
    }
    
    function submitEditUser() {
        const userId = document.getElementById('editUserId').value;
        const password = document.getElementById('editPassword').value;
        
        const formData = {
            username: document.getElementById('editUsername').value,
            email: document.getElementById('editEmail').value,
            phone_number: document.getElementById('editPhone').value,
            role: document.getElementById('editRole').value,
            is_active: document.getElementById('editUserActive').checked
        };
        
        // Only include password if provided
        if (password) {
            formData.password = password;
        }
        
        fetch(`/api/admin/users/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('User updated successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                loadUsers();
            } else {
                showAlert(data.message || 'Failed to update user', 'danger');
            }
        })
        .catch(error => {
            showAlert('Error updating user', 'danger');
        });
    }
    
    function toggleUserStatus(userId, currentStatus) {
        const action = currentStatus ? 'deactivate' : 'activate';
        const confirmMessage = `Are you sure you want to ${action} this user?`;
        
        if (confirm(confirmMessage)) {
            fetch(`/api/admin/users/${userId}/toggle-status`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`User ${action}d successfully`, 'success');
                    loadUsers();
                } else {
                    showAlert(data.message || `Failed to ${action} user`, 'danger');
                }
            })
            .catch(error => {
                showAlert(`Error ${action}ing user`, 'danger');
            });
        }
    }
    
    function deleteUser(userId) {
        if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('User deleted successfully', 'success');
                    loadUsers();
                } else {
                    showAlert(data.message || 'Failed to delete user', 'danger');
                }
            })
            .catch(error => {
                showAlert('Error deleting user', 'danger');
            });
        }
    }
    
    function showAddPackageModal() {
        // Create modal HTML
        const modalHtml = `
            <div class="modal fade" id="addPackageModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Package</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addPackageForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="packageTitle" class="form-label">Title</label>
                                        <input type="text" class="form-control" id="packageTitle" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="packageDestination" class="form-label">Destination</label>
                                        <input type="text" class="form-control" id="packageDestination" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="packagePrice" class="form-label">Price (₹)</label>
                                        <input type="number" class="form-control" id="packagePrice" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="packageDuration" class="form-label">Duration (days)</label>
                                        <input type="number" class="form-control" id="packageDuration" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="packageMaxTravelers" class="form-label">Max Travelers</label>
                                        <input type="number" class="form-control" id="packageMaxTravelers" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="packageDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="packageDescription" rows="3"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="packageAvailableFrom" class="form-label">Available From</label>
                                        <input type="date" class="form-control" id="packageAvailableFrom" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="packageAvailableTo" class="form-label">Available To</label>
                                        <input type="date" class="form-control" id="packageAvailableTo" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitAddPackage()">Add Package</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('addPackageModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('addPackageModal'));
        modal.show();
    }
    
    function submitAddPackage() {
        const formData = {
            title: document.getElementById('packageTitle').value,
            destination: document.getElementById('packageDestination').value,
            price: parseInt(document.getElementById('packagePrice').value),
            duration_days: parseInt(document.getElementById('packageDuration').value),
            max_travelers: parseInt(document.getElementById('packageMaxTravelers').value),
            description: document.getElementById('packageDescription').value,
            available_from: document.getElementById('packageAvailableFrom').value,
            available_to: document.getElementById('packageAvailableTo').value
        };
        
        fetch('/api/packages/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showAlert('Package added successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addPackageModal')).hide();
                loadPackages();
            } else {
                showAlert(data.error || 'Failed to add package', 'danger');
            }
        })
        .catch(error => {
            showAlert('Failed to add package', 'danger');
        });
    }
    
    function editPackage(packageId) {
        // Get package data first
        fetch(`/api/packages/${packageId}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showEditPackageModal(data.package);
            } else {
                showAlert('Failed to load package data', 'danger');
            }
        })
        .catch(error => {
            showAlert('Error loading package data', 'danger');
        });
    }
    
    function showEditPackageModal(package) {
        const modalHtml = `
            <div class="modal fade" id="editPackageModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Package</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editPackageForm">
                                <input type="hidden" id="editPackageId" value="${package.id}">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editPackageTitle" class="form-label">Title</label>
                                        <input type="text" class="form-control" id="editPackageTitle" value="${package.title}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editPackageDestination" class="form-label">Destination</label>
                                        <input type="text" class="form-control" id="editPackageDestination" value="${package.destination}" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="editPackagePrice" class="form-label">Price (₹)</label>
                                        <input type="number" class="form-control" id="editPackagePrice" value="${package.price}" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="editPackageDuration" class="form-label">Duration (days)</label>
                                        <input type="number" class="form-control" id="editPackageDuration" value="${package.duration_days}" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="editPackageMaxTravelers" class="form-label">Max Travelers</label>
                                        <input type="number" class="form-control" id="editPackageMaxTravelers" value="${package.max_travelers}" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editPackageDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="editPackageDescription" rows="3">${package.description || ''}</textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editPackageAvailableFrom" class="form-label">Available From</label>
                                        <input type="date" class="form-control" id="editPackageAvailableFrom" value="${package.available_from}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editPackageAvailableTo" class="form-label">Available To</label>
                                        <input type="date" class="form-control" id="editPackageAvailableTo" value="${package.available_to}" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitEditPackage()">Update Package</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('editPackageModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editPackageModal'));
        modal.show();
    }
    
    function submitEditPackage() {
        const packageId = document.getElementById('editPackageId').value;
        
        const formData = {
            title: document.getElementById('editPackageTitle').value,
            destination: document.getElementById('editPackageDestination').value,
            price: parseInt(document.getElementById('editPackagePrice').value),
            duration_days: parseInt(document.getElementById('editPackageDuration').value),
            max_travelers: parseInt(document.getElementById('editPackageMaxTravelers').value),
            description: document.getElementById('editPackageDescription').value,
            available_from: document.getElementById('editPackageAvailableFrom').value,
            available_to: document.getElementById('editPackageAvailableTo').value
        };
        
        fetch(`/api/packages/${packageId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showAlert('Package updated successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editPackageModal')).hide();
                loadPackages();
            } else {
                showAlert(data.error || 'Failed to update package', 'danger');
            }
        })
        .catch(error => {
            showAlert('Error updating package', 'danger');
        });
    }
    
    function togglePackageStatus(packageId, currentStatus) {
        const action = currentStatus ? 'deactivate' : 'activate';
        const confirmMessage = `Are you sure you want to ${action} this package?`;
        
        if (confirm(confirmMessage)) {
            fetch(`/api/packages/${packageId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ is_active: !currentStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showAlert(`Package ${action}d successfully`, 'success');
                    loadPackages();
                } else {
                    showAlert(data.error || `Failed to ${action} package`, 'danger');
                }
            })
            .catch(error => {
                showAlert(`Error ${action}ing package`, 'danger');
            });
        }
    }
    
    function deletePackage(packageId) {
        if (confirm('Are you sure you want to permanently delete this package? This action cannot be undone and will remove all associated data.')) {
            fetch(`/api/packages/${packageId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showAlert('Package deleted successfully', 'success');
                    loadPackages();
                } else {
                    showAlert(data.error || 'Failed to delete package', 'danger');
                }
            })
            .catch(error => {
                showAlert('Error deleting package', 'danger');
            });
        }
    }
    
    function exportUsers() {
        showAlert('Export users functionality coming soon', 'info');
    }
    
    function exportPackages() {
        showAlert('Export packages functionality coming soon', 'info');
    }
    
    function exportBookings() {
        showAlert('Export bookings functionality coming soon', 'info');
    }
    
    async function viewBooking(bookingId) {
        try {
            const response = await fetch(`/api/admin/bookings/${bookingId}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            const data = await response.json();
            
            if (data.success) {
                const booking = data.booking;
                showBookingDetailsModal(booking);
            } else {
                showAlert(data.message || 'Failed to load booking details', 'danger');
            }
        } catch (error) {
            showAlert('Failed to load booking details', 'danger');
        }
    }
    
    function showBookingDetailsModal(booking) {
        const modalHtml = `
            <div class="modal fade" id="bookingDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Booking Details #${booking.id}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Customer Information</h6>
                                    <p><strong>Name:</strong> ${booking.user.username}</p>
                                    <p><strong>Email:</strong> ${booking.user.email}</p>
                                    <p><strong>Phone:</strong> ${booking.user.phone || 'Not provided'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Booking Information</h6>
                                    <p><strong>Package:</strong> ${booking.package.title}</p>
                                    <p><strong>Destination:</strong> ${booking.package.destination}</p>
                                    <p><strong>Booking Date:</strong> ${new Date(booking.booking_date).toLocaleDateString()}</p>
                                    <p><strong>Travelers:</strong> ${booking.number_of_travelers}</p>
                                    <p><strong>Total Amount:</strong> ₹${booking.total_amount}</p>
                                    <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(booking.status)}">${booking.status}</span></p>
                                </div>
                            </div>
                            ${booking.special_requests ? `
                                <div class="mt-3">
                                    <h6>Special Requests</h6>
                                    <p>${booking.special_requests}</p>
                                </div>
                            ` : ''}
                            <div class="mt-3">
                                <h6>Package Details</h6>
                                <p><strong>Duration:</strong> ${booking.package.duration_days} days</p>
                                <p><strong>Max Travelers:</strong> ${booking.package.max_travelers}</p>
                                <p><strong>Available From:</strong> ${new Date(booking.package.available_from).toLocaleDateString()}</p>
                                <p><strong>Available To:</strong> ${new Date(booking.package.available_to).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="updateBookingStatus(${booking.id})">Update Status</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('bookingDetailsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
        modal.show();
    }
    
    async function updateBookingStatus(bookingId) {
        try {
            const response = await fetch(`/api/admin/bookings/${bookingId}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            const data = await response.json();
            
            if (data.success) {
                const booking = data.booking;
                showUpdateStatusModal(booking);
            } else {
                showAlert(data.message || 'Failed to load booking details', 'danger');
            }
        } catch (error) {
            showAlert('Failed to load booking details', 'danger');
        }
    }
    
    function showUpdateStatusModal(booking) {
        const statusOptions = [
            { value: 'pending', label: 'Pending', color: 'warning' },
            { value: 'confirmed', label: 'Confirmed', color: 'success' },
            { value: 'cancelled', label: 'Cancelled', color: 'danger' },
            { value: 'completed', label: 'Completed', color: 'info' }
        ];
        
        const modalHtml = `
            <div class="modal fade" id="updateStatusModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Update Booking Status</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="bookingStatus" class="form-label">Current Status</label>
                                <span class="badge bg-${getStatusColor(booking.status)} ms-2">${booking.status}</span>
                            </div>
                            <div class="mb-3">
                                <label for="newStatus" class="form-label">New Status</label>
                                <select class="form-select" id="newStatus">
                                    ${statusOptions.map(option => 
                                        `<option value="${option.value}" ${option.value === booking.status ? 'selected' : ''}>${option.label}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="statusNotes" class="form-label">Notes (Optional)</label>
                                <textarea class="form-control" id="statusNotes" rows="3" placeholder="Add any notes about the status change..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitStatusUpdate(${booking.id})">Update Status</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('updateStatusModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
        modal.show();
    }
    
    async function submitStatusUpdate(bookingId) {
        const newStatus = document.getElementById('newStatus').value;
        const notes = document.getElementById('statusNotes').value;
        
        try {
            const response = await fetch(`/api/admin/bookings/${bookingId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    status: newStatus,
                    notes: notes
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Booking status updated successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
                loadBookings();
            } else {
                showAlert(data.message || 'Failed to update booking status', 'danger');
            }
        } catch (error) {
            showAlert('Failed to update booking status', 'danger');
        }
    }
    
    function exportReviews() {
        showAlert('Export reviews functionality coming soon', 'info');
    }
    
    function exportPayments() {
        showAlert('Export payments functionality coming soon', 'info');
    }
    
    function filterUsers() {
        const search = document.getElementById('userSearch').value;
        const role = document.getElementById('roleFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        // Build query parameters
        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (role) params.append('role', role);
        if (status !== '') params.append('is_active', status);
        
        // Fetch filtered users
        fetch(`/api/admin/users?${params.toString()}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        })
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = data.users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.phone_number || 'N/A'}</td>
                    <td><span class="badge bg-${user.role === 'admin' ? 'danger' : user.role === 'travel_agent' ? 'warning' : 'primary'}">${user.role}</span></td>
                    <td><span class="badge bg-${user.is_active ? 'success' : 'secondary'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">Edit</button>
                        <button class="btn btn-sm btn-${user.is_active ? 'outline-warning' : 'outline-success'}" onclick="toggleUserStatus(${user.id}, ${user.is_active})">
                            ${user.is_active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        })
        .catch(error => {
            showAlert('Error filtering users', 'danger');
        });
    }
</script>
{% endblock %}
