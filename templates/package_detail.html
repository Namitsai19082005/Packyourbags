{% extends "base.html" %}

{% block title %}Package Details - Pack Your Bags{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-md-8">
            <!-- Package Details -->
            <div id="packageDetails" class="card">
                <div class="card-body">
                    <!-- Loading state -->
                    <div id="loadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading package details...</p>
                    </div>
                    
                    <!-- Package content -->
                    <div id="packageContent" style="display: none;">
            <!-- Package Images -->
            <div id="packageImages" class="mb-4">
                <!-- Images will be loaded here -->
            </div>
            
                        <!-- Package Info -->
                    <div class="row mb-4">
                            <div class="col-md-8">
                                <h1 id="packageTitle" class="mb-2"></h1>
                                <p class="text-muted mb-3" id="packageDestination"></p>
                                <div class="rating mb-3" id="packageRating">
                                    <!-- Rating will be loaded here -->
                                </div>
                                <p id="packageDescription" class="lead"></p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="text-primary mb-2" id="packagePrice"></h3>
                                        <p class="text-muted mb-3" id="packageDuration"></p>
                                        <p class="text-muted mb-3" id="packageMaxTravelers"></p>
                                        <button class="btn btn-outline-primary w-100" onclick="addToWishlist()">
                                            <i class="fas fa-heart me-2"></i>Add to Wishlist
                                        </button>
                            </div>
                        </div>
                            </div>
                        </div>
                        
                        <!-- Package Details Tabs -->
                        <ul class="nav nav-tabs mb-4" id="packageTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                                    <i class="fas fa-info-circle me-2"></i>Overview
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="includes-tab" data-bs-toggle="tab" data-bs-target="#includes" type="button" role="tab">
                                    <i class="fas fa-check-circle me-2"></i>What's Included
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="excludes-tab" data-bs-toggle="tab" data-bs-target="#excludes" type="button" role="tab">
                                    <i class="fas fa-times-circle me-2"></i>What's Not Included
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
                                    <i class="fas fa-star me-2"></i>Reviews
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="packageTabContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Package Highlights</h5>
                                        <ul id="packageHighlights" class="list-unstyled">
                                            <!-- Highlights will be loaded here -->
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Availability</h5>
                                        <p><strong>Available From:</strong> <span id="availableFrom"></span></p>
                                        <p><strong>Available To:</strong> <span id="availableTo"></span></p>
                                        <p><strong>Maximum Travelers:</strong> <span id="maxTravelers"></span></p>
                            </div>
                        </div>
                    </div>
                    
                            <!-- Includes Tab -->
                            <div class="tab-pane fade" id="includes" role="tabpanel">
                            <ul id="includesList" class="list-group list-group-flush">
                                <!-- Includes will be loaded here -->
                            </ul>
                        </div>
                            
                            <!-- Excludes Tab -->
                            <div class="tab-pane fade" id="excludes" role="tabpanel">
                            <ul id="excludesList" class="list-group list-group-flush">
                                <!-- Excludes will be loaded here -->
                            </ul>
                            </div>
                            
                            <!-- Reviews Tab -->
                            <div class="tab-pane fade" id="reviews" role="tabpanel">
                                <div id="reviewsContainer">
                                    <!-- Reviews will be loaded here -->
                                </div>
                                
                                <!-- Add Review Form -->
                                <div class="card mt-4" id="addReviewForm" style="display: none;">
                                    <div class="card-header">
                                        <h5>Write a Review</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="reviewForm">
                                            <div class="mb-3">
                                                <label for="reviewRating" class="form-label">Rating</label>
                                                <select class="form-select" id="reviewRating" required>
                                                    <option value="">Select Rating</option>
                                                    <option value="5">5 Stars - Excellent</option>
                                                    <option value="4">4 Stars - Very Good</option>
                                                    <option value="3">3 Stars - Good</option>
                                                    <option value="2">2 Stars - Fair</option>
                                                    <option value="1">1 Star - Poor</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="reviewComment" class="form-label">Your Review</label>
                                                <textarea class="form-control" id="reviewComment" rows="4" placeholder="Share your experience..."></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-star me-2"></i>Submit Review
                                            </button>
                                        </form>
                                    </div>
                        </div>
                    </div>
                </div>
            </div>
            
                    <!-- Error state -->
                    <div id="errorState" class="text-center py-5" style="display: none;">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h4>Package Not Found</h4>
                        <p class="text-muted">The package you're looking for doesn't exist or has been removed.</p>
                        <a href="/packages" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Packages
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Booking Summary -->
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-calendar-check me-2"></i>Quick Booking</h5>
                </div>
                <div class="card-body">
                    <form id="quickBookingForm">
                    <div class="mb-3">
                            <label for="travelDate" class="form-label">Travel Date</label>
                            <input type="date" class="form-control" id="travelDate" required>
                    </div>
                    <div class="mb-3">
                            <label for="numTravelers" class="form-label">Number of Travelers</label>
                            <select class="form-select" id="numTravelers" required>
                                <option value="">Select travelers</option>
                                <option value="1">1 Traveler</option>
                                <option value="2">2 Travelers</option>
                                <option value="3">3 Travelers</option>
                                <option value="4">4 Travelers</option>
                                <option value="5">5 Travelers</option>
                                <option value="6">6 Travelers</option>
                                <option value="7">7 Travelers</option>
                                <option value="8">8 Travelers</option>
                        </select>
                    </div>
                    <div class="mb-3">
                            <label for="specialRequests" class="form-label">Special Requests</label>
                        <textarea class="form-control" id="specialRequests" rows="3" placeholder="Any special requirements..."></textarea>
                    </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Total Amount:</span>
                                <strong id="totalAmount">₹0</strong>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-calendar-check me-2"></i>Book Package
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Similar Packages -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-map-marker-alt me-2"></i>Similar Packages</h5>
                    </div>
                <div class="card-body" id="similarPackages">
                    <!-- Similar packages will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPackage = null;
    let packageId = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Get package ID from URL
        const pathParts = window.location.pathname.split('/');
        packageId = pathParts[pathParts.length - 1];
        
        if (packageId) {
            loadPackageDetails();
            loadSimilarPackages();
            checkWishlistStatus();
        } else {
            showError();
        }
        
        // Setup form handlers
        setupFormHandlers();
    });

    async function loadPackageDetails() {
        try {
            const response = await fetch(`/api/packages/${packageId}`);
            
            if (response.ok) {
                const data = await response.json();
                currentPackage = data.package;
                displayPackageDetails();
                updateBookingForm();
            } else if (response.status === 404) {
                showError();
            } else {
                throw new Error('Failed to load package details');
            }
        } catch (error) {
            console.error('Error loading package details:', error);
            showError();
        }
    }

    function displayPackageDetails() {
        const package = currentPackage;
        
        // Hide loading, show content
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('packageContent').style.display = 'block';
        
        // Update page title
        document.title = `${package.title} - Pack Your Bags`;
        
        // Update package info
        document.getElementById('packageTitle').textContent = package.title;
        document.getElementById('packageDestination').textContent = package.destination;
        document.getElementById('packageDescription').textContent = package.description;
        document.getElementById('packagePrice').textContent = `₹${package.price}`;
        document.getElementById('packageDuration').textContent = `${package.duration_days} days`;
        document.getElementById('packageMaxTravelers').textContent = `Max ${package.max_travelers} travelers`;
        
        // Update availability
        document.getElementById('availableFrom').textContent = new Date(package.available_from).toLocaleDateString();
        document.getElementById('availableTo').textContent = new Date(package.available_to).toLocaleDateString();
        document.getElementById('maxTravelers').textContent = package.max_travelers;
        
        // Update rating
        const ratingContainer = document.getElementById('packageRating');
        ratingContainer.innerHTML = `
            ${generateStars(package.average_rating || 0)}
            <span class="ms-2">${package.average_rating || 0}/5</span>
            <small class="text-muted ms-2">(${package.total_reviews || 0} reviews)</small>
        `;
        
        // Update images
        displayPackageImages(package.images || []);
        
        // Update includes/excludes
        displayIncludes(package.includes || []);
        displayExcludes(package.excludes || []);
        
        // Load reviews
        loadPackageReviews();
    }

    function displayPackageImages(images) {
        const container = document.getElementById('packageImages');
        
        if (images && images.length > 0) {
            container.innerHTML = `
                <div id="packageCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        ${images.map((img, index) => `
                            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                <img src="${img}" class="d-block w-100" style="height: 400px; object-fit: cover;" alt="Package Image">
                            </div>
                        `).join('')}
                    </div>
                    ${images.length > 1 ? `
                        <button class="carousel-control-prev" type="button" data-bs-target="#packageCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#packageCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                    ` : ''}
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="bg-light d-flex align-items-center justify-content-center" style="height: 400px;">
                    <div class="text-center text-muted">
                        <i class="fas fa-image fa-3x mb-3"></i>
                        <p>No images available</p>
                    </div>
                </div>
            `;
        }
    }
    
    function displayIncludes(includes) {
        const container = document.getElementById('includesList');
        
        if (includes && includes.length > 0) {
            container.innerHTML = includes.map(item => `
                <li class="list-group-item">
                    <i class="fas fa-check text-success me-2"></i>${item}
                </li>
            `).join('');
        } else {
            container.innerHTML = '<li class="list-group-item text-muted">No information available</li>';
        }
    }

    function displayExcludes(excludes) {
        const container = document.getElementById('excludesList');
        
        if (excludes && excludes.length > 0) {
            container.innerHTML = excludes.map(item => `
                <li class="list-group-item">
                    <i class="fas fa-times text-danger me-2"></i>${item}
                </li>
            `).join('');
        } else {
            container.innerHTML = '<li class="list-group-item text-muted">No information available</li>';
        }
    }
    
    async function loadPackageReviews() {
        try {
            const response = await fetch(`/api/reviews/package/${packageId}`);
            
            if (response.ok) {
                const data = await response.json();
                displayReviews(data.reviews || []);
            }
        } catch (error) {
            console.error('Error loading reviews:', error);
        }
    }
    
    function displayReviews(reviews) {
        const container = document.getElementById('reviewsContainer');
        
        if (reviews.length > 0) {
            container.innerHTML = reviews.map(review => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>${review.user.username}</strong>
                                <div class="rating">${generateStars(review.rating)}</div>
                            </div>
                            <small class="text-muted">${new Date(review.created_at).toLocaleDateString()}</small>
                        </div>
                        <p class="mb-0">${review.comment || 'No comment provided'}</p>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-muted">No reviews yet. Be the first to review this package!</p>';
        }
        
        // Show add review form if user is logged in
        if (authToken) {
            document.getElementById('addReviewForm').style.display = 'block';
        }
    }

    async function loadSimilarPackages() {
        try {
            const response = await fetch(`/api/packages/?per_page=3`);
            
            if (response.ok) {
                const data = await response.json();
                displaySimilarPackages(data.packages || []);
            }
        } catch (error) {
            console.error('Error loading similar packages:', error);
        }
    }

    function displaySimilarPackages(packages) {
        const container = document.getElementById('similarPackages');
        
        if (packages.length > 0) {
            container.innerHTML = packages.map(pkg => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${pkg.title}</h6>
                        <p class="card-text text-muted small">${pkg.destination}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-primary">₹${pkg.price}</span>
                            <a href="/package/${pkg.id}" class="btn btn-outline-primary btn-sm">View</a>
                        </div>
                    </div>
                </div>
            `).join('');
            } else {
            container.innerHTML = '<p class="text-muted">No similar packages found</p>';
        }
    }

    function updateBookingForm() {
        const package = currentPackage;
        const numTravelersSelect = document.getElementById('numTravelers');
        const totalAmountElement = document.getElementById('totalAmount');
        
        // Update max travelers in select
        numTravelersSelect.innerHTML = '<option value="">Select travelers</option>';
        for (let i = 1; i <= package.max_travelers; i++) {
            numTravelersSelect.innerHTML += `<option value="${i}">${i} Traveler${i > 1 ? 's' : ''}</option>`;
        }
        
        // Update total amount when travelers change
        numTravelersSelect.addEventListener('change', function() {
            const numTravelers = parseInt(this.value) || 0;
            const totalAmount = package.price * numTravelers;
            totalAmountElement.textContent = `₹${totalAmount}`;
        });
    }

    function setupFormHandlers() {
        // Quick booking form
        document.getElementById('quickBookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            bookPackage();
        });
        
        // Review form
        document.getElementById('reviewForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitReview();
        });
    }
    
    async function bookPackage() {
        if (!authToken) {
            showAlert('Please login to book a package', 'warning');
            window.location.href = '/login';
            return;
        }
        
        const travelDate = document.getElementById('travelDate').value;
        const numTravelers = document.getElementById('numTravelers').value;
        const specialRequests = document.getElementById('specialRequests').value;
        
        if (!travelDate || !numTravelers) {
            showAlert('Please fill in all required fields', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/bookings/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    package_id: packageId,
                    booking_date: travelDate,
                    number_of_travelers: parseInt(numTravelers),
                    special_requests: specialRequests
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showAlert('Package booked successfully!', 'success');
                // Redirect to bookings page
                window.location.href = '/bookings';
            } else {
                showAlert(data.error || 'Failed to book package', 'danger');
            }
        } catch (error) {
            showAlert('Failed to book package', 'danger');
        }
    }

    async function submitReview() {
        if (!authToken) {
            showAlert('Please login to submit a review', 'warning');
            return;
        }
        
        const rating = document.getElementById('reviewRating').value;
        const comment = document.getElementById('reviewComment').value;
        
        if (!rating) {
            showAlert('Please select a rating', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/reviews', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    package_id: packageId,
                    rating: parseInt(rating),
                    comment: comment
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showAlert('Review submitted successfully', 'success');
                document.getElementById('reviewForm').reset();
                loadPackageReviews(); // Reload reviews
                loadPackageDetails(); // Reload package details to update rating
            } else {
                showAlert(data.error || 'Failed to submit review', 'danger');
            }
        } catch (error) {
            showAlert('Failed to submit review', 'danger');
        }
    }

    async function checkWishlistStatus() {
        if (!authToken) return;
        
        try {
            const response = await fetch('/api/wishlist/', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const isInWishlist = data.wishlist.some(item => item.package.id == packageId);
                updateWishlistButton(isInWishlist);
            }
        } catch (error) {
            console.error('Error checking wishlist status:', error);
        }
    }
    
    function updateWishlistButton(isInWishlist) {
        const wishlistBtn = document.querySelector('button[onclick*="Wishlist"]');
        if (!wishlistBtn) return;
        
        if (isInWishlist) {
            wishlistBtn.innerHTML = '<i class="fas fa-heart me-2"></i>Remove from Wishlist';
            wishlistBtn.setAttribute('onclick', 'removeFromWishlist()');
            wishlistBtn.classList.remove('btn-outline-primary');
            wishlistBtn.classList.add('btn-danger');
        } else {
            wishlistBtn.innerHTML = '<i class="fas fa-heart me-2"></i>Add to Wishlist';
            wishlistBtn.setAttribute('onclick', 'addToWishlist()');
            wishlistBtn.classList.remove('btn-danger');
            wishlistBtn.classList.add('btn-outline-primary');
        }
    }

    async function addToWishlist() {
        if (!authToken) {
            showAlert('Please login to add to wishlist', 'warning');
            window.location.href = '/login';
            return;
        }
        
        try {
            const response = await fetch('/api/wishlist/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ package_id: packageId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Added to wishlist!', 'success');
                updateWishlistButton(true);
            } else {
                showAlert(data.error || 'Failed to add to wishlist', 'danger');
            }
        } catch (error) {
            showAlert('Failed to add to wishlist', 'danger');
        }
    }
    
    async function removeFromWishlist() {
        try {
            const response = await fetch(`/api/wishlist/${packageId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Removed from wishlist!', 'success');
                updateWishlistButton(false);
            } else {
                showAlert(data.error || 'Failed to remove from wishlist', 'danger');
            }
        } catch (error) {
            showAlert('Failed to remove from wishlist', 'danger');
        }
    }

    function generateStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                stars += '<i class="fas fa-star text-warning"></i>';
            } else if (i - 0.5 <= rating) {
                stars += '<i class="fas fa-star-half-alt text-warning"></i>';
            } else {
                stars += '<i class="far fa-star text-warning"></i>';
            }
        }
        return stars;
    }

    function showError() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
    }
</script>
{% endblock %}